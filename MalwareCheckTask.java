package com.example.projectapp;
import android.os.AsyncTask;
import android.widget.TextView;
import org.json.JSONObject;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;

public class MalwareCheckTask extends AsyncTask<String, Void, String> {

    private final TextView malwareRiskTextView;
    private final boolean isUrl;
    private static final String API_KEY = "f099fd030f62459cb8eebaed9d078c1c2f08179ddd6016c5407ff7a141c88a3f"; // Replace with your actual VirusTotal API key

    public MalwareCheckTask(TextView malwareRiskTextView, boolean isUrl) {
        this.malwareRiskTextView = malwareRiskTextView;
        this.isUrl = isUrl;
    }

    @Override
    protected String doInBackground(String... params) {
        String input = params[0];
        try {
            String apiUrl;

            // Choose URL or IP API endpoint based on input type
            if (isUrl) {
                apiUrl = "https://www.virustotal.com/vtapi/v2/url/report?apikey=" + API_KEY + "&resource=" + input;
            } else {
                apiUrl = "https://www.virustotal.com/vtapi/v2/ip-address/report?apikey=" + API_KEY + "&ip=" + input;
            }

            // Open the connection
            URL url = new URL(apiUrl);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");

            BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
            String inputLine;
            StringBuilder response = new StringBuilder();
            while ((inputLine = in.readLine()) != null) {
                response.append(inputLine);
            }
            in.close();

            // Parse the JSON response
            JSONObject jsonResponse = new JSONObject(response.toString());
            return parseMalwareResponse(jsonResponse);

        } catch (Exception e) {
            return "Error checking malware risk: " + e.getMessage();
        }
    }

    @Override
    protected void onPostExecute(String result) {
        malwareRiskTextView.setText(result);
    }

    private String parseMalwareResponse(JSONObject jsonResponse) {
        // Parse the JSON response to extract detailed malware information
        if (jsonResponse.optInt("positives") > 0) {
            return "Warning: This URL/IP might lead to malware! Positive scans: " + jsonResponse.optInt("positives");
        } else {
            return "No immediate malware risk detected.";
        }
    }
}
